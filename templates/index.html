<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
    <style>
    .line { 
	fill: none;
	stroke: blue;
	stroke-width: 1px;
    }
    .axis path,
    .axis line {
	fill: none;
	stroke: black;
	shape-rendering: crispEdges;
    }
    .axis text {
	font-size: 0.7em;
	font-family: sans-serif;
	font-weight: normal;
	font-color: black;
    }
    </style>
  </head>
  <body>
    <script src="http://d3js.org/d3.v3.js"></script>
    <script>
    var high_load_state = false;

    function load_graph(width_in, height_in, 
                        seconds_between_samples, 
                        number_of_samples_in_graph) {

        var data = [],
            duration = seconds_between_samples * 1000;
            n = number_of_samples_in_graph,
            total_seconds = n * seconds_between_samples;
            now = new Date(Date.now() - duration),
            time_parser = d3.time.format.iso.parse;

        var description = "Load over last ";

        if (total_seconds > 60) {
           description += total_seconds / 60 + 
                          " minutes (polling every " + 
                          seconds_between_samples + " sec)";
        } else {
           description += total_seconds + 
                          " seconds (polling every " + 
                          seconds_between_samples + " sec)";
        }

        //init data
        var i = 0;
        for (i = 0; i < n; i++) {
            data[i] = {'load': 1,
                       'timestamp': new Date(Date.now() - (n - i) * duration) }
        }

        var margin = {top: 20,
                      right: 20,
                      bottom: 30,
                      left: 50}

        var width = width_in - margin.left - margin.right;
        var height = height_in - margin.top - margin.bottom;

        var x = d3.time.scale()
            .domain(d3.extent(data, function (d) { return d.timestamp; }))
            .range([0, width]);
        var y = d3.scale.linear()
            .domain([0, d3.max(data, function (d) { return d.load; })])
            .range([height, 0]);

        var line = d3.svg.line()
            .x(function (d) { return x(d.timestamp); })
            .y(function (d) { return y(d.load); });

        d3.select("body").append("h4").text(description);

        var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var x_axis = d3.svg.axis().scale(x).orient("bottom").ticks(width / 40);
        var y_axis = d3.svg.axis().scale(y).orient("left").ticks(height / 40);

        var x_axis_g = svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(x_axis);

        var y_axis_g = svg.append("g")
            .attr("class", "y axis")
            .call(y_axis);

        //used for animation of line
        svg.append("defs")
            .append("clipPath")
            .attr("id","clip")
            .append("rect")
            .attr("width",width)
            .attr("height", height);

        var path = svg.append("g")
            .attr("clip-path", "url(#clip)")
            .append("path")
            .data([data])
            .attr("class","line");

        advance();

        function advance() {
            d3.json("/load.json", function(error, root) {
                root.timestamp = time_parser(root.timestamp);
                data.push(root);

                x.domain(d3.extent(data, function(d) { return d.timestamp; }));
                y.domain([0, d3.max(data, function(d) { return d.load; })]);

                x_axis_g.transition().duration(duration).ease("linear").call(x_axis);
                y_axis_g.transition().duration(duration).ease("linear").call(y_axis);

                path.attr("d", line)
                    .attr("transform", null)
                    .transition()
                    .duration(duration)
                    .ease("linear")
                    .attr("transform", "translate(" + x(data[0].timestamp - duration) + ")")
                    .each("end", advance);

                data.shift();
            })
        }
    }

    load_graph(500, 150, 0.25, 120);
    load_graph(500, 150, 1, 120);
    load_graph(500, 150, 10, 60);
    </script>
    <div class="alerts"></div>
  </body>
</html>
